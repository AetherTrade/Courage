{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <!-- API Connection Card -->
            <div class="card api-card mb-4">
                <div class="card-body">
                    <h3 class="card-title">CourageFX Precision Master</h3>
                    <p class="text-muted">Rise/Fall Market Expert</p>
                    
                    <div class="features mb-4">
                        <div><i class="bx bx-check text-success"></i> Trend direction analysis</div>
                        <div><i class="bx bx-check text-success"></i> Multiple timeframe strategy</div>
                        <div><i class="bx bx-check text-success"></i> Dynamic entry points</div>
                        <div><i class="bx bx-check text-success"></i> Automated trend following</div>
                    
                    <form id="apiForm">
                        <div class="mb-3">
                            <label class="form-label">Deriv API Token</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="apiToken" required>
                                <button class="btn btn-outline-secondary" type="button" id="toggleToken">
                                    <i class="bx bx-show"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                Get your API token from <a href="https://app.deriv.com/account/api-token" target="_blank">Deriv</a>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="connectBtn">
                            <i class="bx bx-link"></i>
                            <span class="loading-spinner spinner-border spinner-border-sm"></span>
                            Connect
                        </button>
                    </form>
                </div>
            </div>

            <!-- Account Info Card -->
            <div class="card api-card mb-4" id="accountInfo" style="display: none;">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="mb-1" id="accountName">-</h5>
                            <p class="text-muted mb-0" id="accountType">-</p>
                        </div>
                        <div class="col-auto">
                            <div class="balance-card p-3 rounded">
                                <div class="balance-value" id="balanceAmount">0.00</div>
                                <div class="currency" id="balanceCurrency">USD</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-outline-danger mt-3" id="disconnectBtn">
                        <i class="bx bx-log-out"></i> Disconnect
                    </button>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="card api-card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Activity Log</h5>
                    <div class="activity-log" id="activityLog"></div>
                </div>
            </div>

            <!-- Trading Controls -->
            <div class="card api-card mb-4" id="tradingSection" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title mb-4">Precision Master Trading Bot</h5>
                    
                    <div class="trading-controls">
                        <div class="trade-params">
                            <!-- Barrier input -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Barrier Digit</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="targetDigit" 
                                           min="0" 
                                           max="9" 
                                           step="1" 
                                           value="0"
                                           placeholder="Enter digit (0-9)">
                                    <div class="form-text">Enter any digit between 0 and 9</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Prediction</label>
                                    <select class="form-control" id="digitPrediction">
                                        <option value="over">Over</option>
                                        <option value="under">Under</option>
                                        <option value="matches">Matches</option>
                                        <option value="differs">Differs</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Market Selection -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Market</label>
                                    <select class="form-control" id="market">
                                        <optgroup label="1 Second Volatility">
                                            <option value="1HZ10V">Volatility 10 (1s)</option>
                                            <option value="1HZ25V">Volatility 25 (1s)</option>
                                            <option value="1HZ50V">Volatility 50 (1s)</option>
                                            <option value="1HZ75V">Volatility 75 (1s)</option>
                                            <option value="1HZ100V">Volatility 100 (1s)</option>
                                        </optgroup>
                                        <optgroup label="Standard Volatility">
                                            <option value="R_10">Volatility 10</option>
                                            <option value="R_25">Volatility 25</option>
                                            <option value="R_50">Volatility 50</option>
                                            <option value="R_75">Volatility 75</option>
                                            <option value="R_100">Volatility 100</option>
                                        </optgroup>
                                        <optgroup label="Crash/Boom">
                                            <option value="CRASH_1000">Crash 1000</option>
                                            <option value="BOOM_1000">Boom 1000</option>
                                            <option value="CRASH_500">Crash 500</option>
                                            <option value="BOOM_500">Boom 500</option>
                                        </optgroup>
                                        <optgroup label="Standard Markets">
                                            <option value="R_10">Volatility 10 Index</option>
                                            <option value="R_25">Volatility 25 Index</option>
                                            <option value="R_50">Volatility 50 Index</option>
                                            <option value="R_75">Volatility 75 Index</option>
                                            <option value="R_100">Volatility 100 Index</option>
                                            <option value="RDBEAR">Bear Market Index</option>
                                            <option value="RDBULL">Bull Market Index</option>
                                        </optgroup>
                                    </select>
                                    <div class="form-text text-white-50">
                                        Select market type and volatility level
                                    </div>
                                </div>
                            </div>

                            <!-- Trade Type and Barrier -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Trade Type</label>
                                    <select class="form-control" id="tradingStrategy">
                                        <option value="over">Goes Over</option>
                                        <option value="under">Goes Under</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Barrier</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="barrierOffset" value="0" step="0.1">
                                        <button class="btn btn-outline-secondary" type="button" id="addTick">+</button>
                                        <button class="btn btn-outline-secondary" type="button" id="subTick">-</button>
                                    </div>
                                    <small class="form-text text-muted">Current spot: <span id="currentSpot">0.00</span></small>
                                </div>
                            </div>

                            <!-- Duration -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Duration</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="duration" value="1" min="1">
                                        <select class="form-select" id="durationType" style="max-width: 110px;">
                                            <option value="t">Tick</option>
                                            <option value="s">Second</option>
                                            <option value="m">Minute</option>
                                            <option value="h">Hour</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Stake</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="stakeAmount" value="10" min="0.35" step="0.01">
                                        <span class="input-group-text" id="stakeCurrency">USD</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Payout Display -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="payout-info p-3 rounded bg-light">
                                        <div class="d-flex justify-content-between">
                                            <span>Potential Payout:</span>
                                            <span id="potentialPayout">0.00 USD</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Payout Limit:</span>
                                            <span>20000.00 USD</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Add these fields right after the barrier offset field -->
                            <div class="form-group mb-3">
                                <label for="barrierOffset">Barrier Offset</label>
                                <input type="number" class="form-control" id="barrierOffset" value="0" min="0" max="9">
                            </div>

                            <!-- Add these new fields here -->
                            <div class="form-group mb-3">
                                <label for="recoveryBarrier" class="text-warning">Recovery Barrier</label>
                                <input type="number" class="form-control" id="recoveryBarrier" value="5" min="0" max="9" 
                                       placeholder="Enter recovery barrier (0-9)">
                                <small class="form-text text-muted">Barrier to use after a loss</small>
                            </div>

                            <div class="form-group mb-3">
                                <label for="recoveryStrategy" class="text-warning">Recovery Strategy</label>
                                <select class="form-control" id="recoveryStrategy">
                                    <option value="over">Over</option>
                                    <option value="under">Under</option>
                                </select>
                                <small class="form-text text-muted">Strategy to use for recovery trades</small>
                            </div>

                            <!-- Add after the first recovery barrier -->
                            <div class="form-group mb-3">
                                <label for="secondaryRecoveryBarrier" class="text-warning">Secondary Recovery Barrier</label>
                                <input type="number" class="form-control" id="secondaryRecoveryBarrier" value="7" min="0" max="9" 
                                       placeholder="Enter secondary recovery barrier (0-9)">
                                <small class="form-text text-muted">Barrier to use if first recovery trade loses</small>
                            </div>

                            <div class="form-group mb-3">
                                <label for="secondaryRecoveryStrategy" class="text-warning">Secondary Recovery Strategy</label>
                                <select class="form-control" id="secondaryRecoveryStrategy">
                                    <option value="over">Over</option>
                                    <option value="under">Under</option>
                                </select>
                                <small class="form-text text-muted">Strategy to use for secondary recovery trades</small>
                            </div>

                            <!-- Trading Buttons -->
                            <div class="d-flex justify-content-between gap-3">
                                <button class="btn btn-success flex-grow-1 py-3" id="startBot">
                                    <i class="bx bx-trending-up me-2"></i>
                                    <span>Start Auto-Trading</span>
                                    <div class="potential-return" id="buyReturn">0.00</div>
                                </button>
                                <button class="btn btn-danger flex-grow-1 py-3" id="stopBot" disabled>
                                    <i class="bx bx-stop-circle me-2"></i>
                                    <span>Stop Trading</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Moved Trading Stats here -->
            <div class="card api-card mb-4" id="tradingStats" style="display: none;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Trading Statistics</h5>
                        <button class="btn btn-outline-warning btn-sm" id="refreshStats">
                            <i class="bx bx-refresh me-1"></i>Reset Stats
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-item">
                                <label>Total Trades</label>
                                <div class="stat-value" id="totalTrades">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <label>Wins</label>
                                <div class="stat-value text-success" id="winCount">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <label>Losses</label>
                                <div class="stat-value text-danger" id="lossCount">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <label>Profit/Loss</label>
                                <div class="stat-value" id="profitLoss">0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Info Card -->
            <div class="card api-card mb-4" id="marketInfo" style="display: none;">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="market-stat">
                                <label>Current Price</label>
                                <div class="stat-value" id="currentPrice">0.00000</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="market-stat">
                                <label>Last Digit</label>
                                <div class="stat-value digit-display" id="lastDigit">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Keep existing styles and JavaScript -->
<script>
// Initialize variables
let ws = null;
let isTrading = false;
let currentContract = null;
let tradeTimeout = null;
const tradingStats = {
    totalTrades: 0,
    wins: 0,
    losses: 0,
    profitLoss: 0
};
let lastPrice = 0;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check for stored API token
    const storedToken = localStorage.getItem('deriv_api_token');
    if (storedToken) {
        document.getElementById('apiToken').value = storedToken;
        // Auto-connect if token exists
        document.getElementById('apiForm').dispatchEvent(new Event('submit'));
    }
    addLogEntry('Bot initialized and ready to connect', 'info');
});

// Toggle API token visibility
document.getElementById('toggleToken').addEventListener('click', function() {
    const apiToken = document.getElementById('apiToken');
    const icon = this.querySelector('i');
    if (apiToken.type === 'password') {
        apiToken.type = 'text';
        icon.classList.replace('bx-show', 'bx-hide');
    } else {
        apiToken.type = 'password';
        icon.classList.replace('bx-hide', 'bx-show');
    }
});

// WebSocket message handler
function handleMessage(msg) {
    const data = JSON.parse(msg.data);
    
    console.log('Received message:', data);
    
    switch(data.msg_type) {
        case 'authorize':
            handleAuth(data);
            break;
        case 'balance':
            handleBalance(data);
            break;
        case 'proposal':
            handleProposal(data);
            break;
        case 'buy':
            handleBuy(data);
            break;
        case 'proposal_open_contract':
            handleContract(data);
            break;
        case 'tick':
            handleTick(data.tick);
            break;
        case 'error':
            handleError(data);
            break;
    }
}

function handleAuth(data) {
    if (data.error) return;
    addLogEntry('Successfully authorized', 'success');
    addLogEntry(`Welcome back, ${data.authorize.fullname}`, 'info');
    
    document.getElementById('accountName').textContent = data.authorize.fullname;
    document.getElementById('accountType').textContent = 
        data.authorize.landing_company_name.toUpperCase();
    document.getElementById('tradingSection').style.display = 'block';
    document.getElementById('marketInfo').style.display = 'block';
    
    // Subscribe to balance and market ticks
    ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
    subscribeToTicks();
}

function handleBalance(data) {
    if (data.error) return;
    const balance = parseFloat(data.balance.balance).toFixed(2);
    const currency = data.balance.currency;
    
    addLogEntry(`Account balance: ${balance} ${currency}`, 'success');
    
    document.getElementById('balanceAmount').textContent = balance;
    document.getElementById('balanceCurrency').textContent = currency;
    document.getElementById('stakeCurrency').textContent = currency;
    document.getElementById('accountInfo').style.display = 'block';
    document.getElementById('apiForm').style.display = 'none';
}

function handleProposal(data) {
    if (data.error) {
        addLogEntry(`Proposal error: ${data.error.message}`, 'error');
        return;
    }
    
    if (data.proposal && data.proposal.id) {
        const buyRequest = {
            buy: data.proposal.id,
            price: data.proposal.ask_price
        };
        
        console.log('Sending buy request:', buyRequest);
        addLogEntry(`Placing trade with proposal ID: ${data.proposal.id}`, 'info');
        ws.send(JSON.stringify(buyRequest));
    }
}

function handleBuy(data) {
    if (data.error) {
        addLogEntry(`Trade error: ${data.error.message}`, 'error');
        
        // Retry trade after error
        setTimeout(() => {
            if (isTrading) {
                addLogEntry('Retrying trade after error...', 'info');
                placeTrade();
            }
        }, 1000);
        return;
    }
    
    const contract = data.buy;
    currentContract = contract.contract_id;
    
    addLogEntry(`Trade placed successfully: ${contract.longcode}`, 'success');
    addLogEntry(`Contract ID: ${contract.contract_id}`, 'info');
    
    
    // Subscribe to contract updates
    ws.send(JSON.stringify({
        proposal_open_contract: 1,
        contract_id: contract.contract_id,
        subscribe: 1
    }));
}

function handleContract(data) {
    if (data.error) return;
    
    const contract = data.proposal_open_contract;
    
    if (contract.is_sold) {
        const profit = parseFloat(contract.profit).toFixed(2);
        tradingStats.totalTrades++;
        
        if (parseFloat(profit) > 0) {
            tradingStats.wins++;
            addLogEntry(`Trade won: +${profit} USD`, 'success');
            // Update total profit/loss
            tradingStats.profitLoss = (parseFloat(tradingStats.profitLoss) + parseFloat(profit)).toFixed(2);
            
            // Check which strategy was active
            const isRecoveryTrade = document.getElementById('tradingStrategy').disabled;
            const isSecondaryRecoveryTrade = document.getElementById('secondaryRecoveryBarrier').disabled;
            
            if (isSecondaryRecoveryTrade) {
                // If secondary recovery won, switch back to initial strategy
                document.getElementById('tradingStrategy').disabled = false;
                document.getElementById('barrierOffset').disabled = false;
                document.getElementById('recoveryBarrier').disabled = false;
                document.getElementById('recoveryStrategy').disabled = false;
                document.getElementById('secondaryRecoveryBarrier').disabled = false;
                document.getElementById('secondaryRecoveryStrategy').disabled = false;
                
                addLogEntry('Secondary recovery won! Switching back to initial strategy...', 'success');
            } else if (isRecoveryTrade) {
                // If primary recovery won, switch back to initial strategy
                document.getElementById('tradingStrategy').disabled = false;
                document.getElementById('barrierOffset').disabled = false;
                
                addLogEntry('Recovery trade won! Switching back to initial strategy...', 'success');
            }
            
            // Unsubscribe from current contract
            ws.send(JSON.stringify({ forget: contract.id }));
            currentContract = null;
            
            // Continue trading
            setTimeout(() => {
                if (isTrading) {
                    placeTrade();
                }
            }, 1000);
            
        } else {
            tradingStats.losses++;
            addLogEntry(`Trade lost: ${profit} USD`, 'error');
            // Update total profit/loss
            tradingStats.profitLoss = (parseFloat(tradingStats.profitLoss) + parseFloat(profit)).toFixed(2);
            
            // Check which strategy was active
            const isRecoveryTrade = document.getElementById('tradingStrategy').disabled;
            const isSecondaryRecoveryTrade = document.getElementById('secondaryRecoveryBarrier').disabled;
            
            if (!isRecoveryTrade) {
                // Initial strategy lost, switch to primary recovery
                const recoveryBarrier = document.getElementById('recoveryBarrier').value;
                const recoveryStrategy = document.getElementById('recoveryStrategy').value;
                
                // Lock initial strategy controls
                document.getElementById('tradingStrategy').disabled = true;
                document.getElementById('barrierOffset').disabled = true;
                
                addLogEntry(`Initial strategy lost. Switching to recovery mode: ${recoveryStrategy.toUpperCase()} ${recoveryBarrier}`, 'warning');
                
                // Unsubscribe and place recovery trade
                ws.send(JSON.stringify({ forget: contract.id }));
                currentContract = null;
                
                setTimeout(() => {
                    if (isTrading) {
                        placeRecoveryTrade();
                    }
                }, 1000);
            } else if (!isSecondaryRecoveryTrade) {
                // Primary recovery lost, switch to secondary recovery
                const secondaryBarrier = document.getElementById('secondaryRecoveryBarrier').value;
                const secondaryStrategy = document.getElementById('secondaryRecoveryStrategy').value;
                
                // Lock primary recovery controls
                document.getElementById('recoveryBarrier').disabled = true;
                document.getElementById('recoveryStrategy').disabled = true;
                document.getElementById('secondaryRecoveryBarrier').disabled = true;
                
                addLogEntry(`Recovery trade lost. Switching to secondary recovery: ${secondaryStrategy.toUpperCase()} ${secondaryBarrier}`, 'warning');
                
                // Unsubscribe and place secondary recovery trade
                ws.send(JSON.stringify({ forget: contract.id }));
                currentContract = null;
                
                setTimeout(() => {
                    if (isTrading) {
                        placeSecondaryRecoveryTrade();
                    }
                }, 1000);
            } else {
                // Secondary recovery lost, stay in secondary recovery mode
                addLogEntry('Secondary recovery trade lost. Continuing with secondary recovery...', 'warning');
                
                // Unsubscribe and continue with secondary recovery
                ws.send(JSON.stringify({ forget: contract.id }));
                currentContract = null;
                
                setTimeout(() => {
                    if (isTrading) {
                        placeSecondaryRecoveryTrade();
                    }
                }, 1000);
            }
        }
        
        updateStats();
    }
}

function continueTradingLoop() {
    if (!isTrading) return;
    
    if (tradeTimeout) {
        clearTimeout(tradeTimeout);
    }
    
    tradeTimeout = setTimeout(() => {
        if (isTrading && !currentContract) {
            placeTrade();
        }
    }, 1000);
}

function placeTrade() {
    if (!isTrading || currentContract) return;
    
    const market = document.getElementById('market').value;
    const stake = document.getElementById('stakeAmount').value;
    const duration = document.getElementById('duration').value;
    const durationType = document.getElementById('durationType').value;
    const strategy = document.getElementById('tradingStrategy').value;
    const barrierDigit = document.getElementById('targetDigit').value;
    
    // First request a proposal
    const proposalRequest = {
        proposal: 1,
        amount: parseFloat(stake),
        basis: "stake",
        contract_type: strategy === 'over' ? 'DIGITOVER' : 'DIGITUNDER',
        currency: "USD",
        symbol: market,
        duration: parseInt(duration),
        duration_unit: durationType,
        barrier: barrierDigit.toString()
    };
    
    try {
        console.log('Sending proposal request:', proposalRequest);
        addLogEntry(`Requesting proposal for ${strategy.toUpperCase()} ${barrierDigit}...`, 'info');
        ws.send(JSON.stringify(proposalRequest));
    } catch (error) {
        console.error('Error sending proposal request:', error);
        addLogEntry(`Error sending proposal request: ${error.message}`, 'error');
    }
}

function placeRecoveryTrade() {
    if (!isTrading || currentContract) return;
    
    const market = document.getElementById('market').value;
    const stake = document.getElementById('stakeAmount').value;
    const duration = document.getElementById('duration').value;
    const durationType = document.getElementById('durationType').value;
    const recoveryBarrier = document.getElementById('recoveryBarrier').value;
    const recoveryStrategy = document.getElementById('recoveryStrategy').value;
    
    const proposalRequest = {
        proposal: 1,
        amount: parseFloat(stake),
        basis: "stake",
        contract_type: recoveryStrategy === 'over' ? 'DIGITOVER' : 'DIGITUNDER',
        currency: "USD",
        symbol: market,
        duration: parseInt(duration),
        duration_unit: durationType,
        barrier: recoveryBarrier.toString()
    };
    
    try {
        console.log('Sending recovery proposal request:', proposalRequest);
        addLogEntry(`Requesting recovery proposal for ${recoveryStrategy.toUpperCase()} ${recoveryBarrier}...`, 'info');
        ws.send(JSON.stringify(proposalRequest));
    } catch (error) {
        console.error('Error sending recovery proposal request:', error);
        addLogEntry(`Error sending recovery proposal: ${error.message}`, 'error');
    }
}

// Add new function for secondary recovery trade
function placeSecondaryRecoveryTrade() {
    if (!isTrading || currentContract) return;
    
    const market = document.getElementById('market').value;
    const stake = document.getElementById('stakeAmount').value;
    const duration = document.getElementById('duration').value;
    const durationType = document.getElementById('durationType').value;
    const secondaryBarrier = document.getElementById('secondaryRecoveryBarrier').value;
    const secondaryStrategy = document.getElementById('secondaryRecoveryStrategy').value;
    
    const proposalRequest = {
        proposal: 1,
        amount: parseFloat(stake),
        basis: "stake",
        contract_type: secondaryStrategy === 'over' ? 'DIGITOVER' : 'DIGITUNDER',
        currency: "USD",
        symbol: market,
        duration: parseInt(duration),
        duration_unit: durationType,
        barrier: secondaryBarrier.toString()
    };
    
    try {
        console.log('Sending secondary recovery proposal request:', proposalRequest);
        addLogEntry(`Requesting secondary recovery proposal for ${secondaryStrategy.toUpperCase()} ${secondaryBarrier}...`, 'info');
        ws.send(JSON.stringify(proposalRequest));
    } catch (error) {
        console.error('Error sending secondary recovery proposal request:', error);
        addLogEntry(`Error sending secondary recovery proposal: ${error.message}`, 'error');
    }
}

// Initialize WebSocket connection
document.getElementById('apiForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const token = document.getElementById('apiToken').value;
    
    ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');
    ws.onmessage = handleMessage;
    
    ws.onopen = function() {
        addLogEntry('WebSocket connection established', 'success');
        ws.send(JSON.stringify({ authorize: token }));
    };
});

// Start trading button
document.getElementById('startBot').addEventListener('click', function() {
    isTrading = true;
    currentContract = null;
    this.disabled = true;
    document.getElementById('stopBot').disabled = false;
    document.getElementById('tradingStrategy').disabled = false;
    document.getElementById('barrierOffset').disabled = false;
    addLogEntry('Starting new trading cycle', 'success');
    placeTrade();
});

// Stop trading button
document.getElementById('stopBot').addEventListener('click', function() {
    isTrading = false;
    this.disabled = true;
    document.getElementById('startBot').disabled = false;
    
    if (tradeTimeout) {
        clearTimeout(tradeTimeout);
        tradeTimeout = null;
    }
    
    if (currentContract) {
        ws.send(JSON.stringify({ forget: currentContract }));
        currentContract = null;
    }
    
    addLogEntry('Bot manually stopped trading', 'warning');
});

// Update statistics display
function updateStats() {
    const statsDiv = document.getElementById('tradingStats');
    if (statsDiv) {
        statsDiv.style.display = 'block';
    }
    
    const elements = {
        totalTrades: document.getElementById('totalTrades'),
        winCount: document.getElementById('winCount'),
        lossCount: document.getElementById('lossCount'),
        profitLoss: document.getElementById('profitLoss')
    };
    
    // Safely update stats
    if (elements.totalTrades) elements.totalTrades.textContent = tradingStats.totalTrades;
    if (elements.winCount) elements.winCount.textContent = tradingStats.wins;
    if (elements.lossCount) elements.lossCount.textContent = tradingStats.losses;
    if (elements.profitLoss) {
        const profitLossValue = parseFloat(tradingStats.profitLoss);
        elements.profitLoss.textContent = `${profitLossValue >= 0 ? '+' : ''}${profitLossValue.toFixed(2)} USD`;
        elements.profitLoss.classList.remove('text-success', 'text-danger');
        elements.profitLoss.classList.add(profitLossValue >= 0 ? 'text-success' : 'text-danger');
    }
}

// Add log entry
function addLogEntry(message, type = 'info') {
    const log = document.getElementById('activityLog');
    const time = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    entry.innerHTML = `[${time}] ${type.toUpperCase()} ${message}`;
    log.insertBefore(entry, log.firstChild);
}

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
    }
});

// Add some styles
const styles = `
    .stat-item {
        text-align: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        margin-bottom: 10px;
    }
    
    .stat-item label {
        font-size: 0.9rem;
        color: #888;
        margin-bottom: 5px;
    }
    
    .stat-item .stat-value {
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .text-success { color: #69f0ae !important; }
    .text-danger { color: #ff5252 !important; }
`;

// Add styles to document
const styleSheet = document.createElement("style");
styleSheet.innerText = styles;
document.head.appendChild(styleSheet);

// Update placeBotTrade function to properly use the barrier
function placeBotTrade() {
    if (!isTrading) return;
    
    const market = document.getElementById('market').value;
    const barrierDigit = document.getElementById('targetDigit').value;
    const prediction = document.getElementById('digitPrediction').value;
    const stake = document.getElementById('stakeAmount').value;
    const duration = document.getElementById('duration').value;
    const durationType = document.getElementById('durationType').value;

    // Debug log
    console.log('Current barrier digit:', barrierDigit);

    // Create the proposal request with explicit barrier
    const proposalRequest = {
        proposal: 1,
        amount: parseFloat(stake),
        basis: "stake",
        contract_type: prediction === 'over' ? 'DIGITOVER' : 
                      prediction === 'under' ? 'DIGITUNDER' :
                      prediction === 'matches' ? 'DIGITMATCHES' : 'DIGITDIFFERS',
        currency: "USD",
        duration: parseInt(duration),
        duration_unit: durationType,
        symbol: market,
        barrier: barrierDigit.toString() // Ensure barrier is sent as string
    };

    // Log the full request
    console.log('Sending trade request:', proposalRequest);
    
    // Send the request
    ws.send(JSON.stringify(proposalRequest));
    
    // Log the trade details
    addLogEntry(`Requesting ${prediction.toUpperCase()} ${barrierDigit} trade on ${market}...`, 'info');
}

// Add input validation and immediate update
document.addEventListener('DOMContentLoaded', function() {
    const targetDigitInput = document.getElementById('targetDigit');
    
    targetDigitInput.addEventListener('input', function() {
        let value = parseInt(this.value);
        
        // Validate and update immediately
        if (isNaN(value) || value < 0) {
            value = 0;
        } else if (value > 9) {
            value = 9;
        }
        
        this.value = value.toString();
        console.log('Barrier digit updated to:', this.value);
        addLogEntry(`Barrier digit set to ${this.value}`, 'info');
    });

    // Ensure initial value is set
    if (!targetDigitInput.value) {
        targetDigitInput.value = '0';
    }
});

// Add prediction type validation
document.getElementById('digitPrediction').addEventListener('change', function() {
    const digit = document.getElementById('targetDigit').value;
    addLogEntry(`Prediction type changed to ${this.value.toUpperCase()} ${digit}`, 'info');
});

// Add error handler
function handleError(data) {
    console.error('API Error:', data);
    addLogEntry(`API Error: ${data.error.message}`, 'error');
    
    // Reset trading state if needed
    if (isTrading) {
        setTimeout(() => {
            if (isTrading) {
                addLogEntry('Retrying trade...', 'info');
                placeTrade();
            }
        }, 1000);
    }
}

// Update the disconnect button handler
document.getElementById('disconnectBtn').addEventListener('click', function() {
    // Stop trading if active
    if (isTrading) {
        stopTrading();
    }
    
    // Close WebSocket connection
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
    }
    
    // Reset all trading stats
    document.getElementById('totalTrades').textContent = '0';
    document.getElementById('winCount').textContent = '0';
    document.getElementById('lossCount').textContent = '0';
    document.getElementById('profitLoss').textContent = '0.00';
    
    // Hide trading sections
    document.getElementById('accountInfo').style.display = 'none';
    document.getElementById('tradingSection').style.display = 'none';
    document.getElementById('tradingStats').style.display = 'none';
    
    // Show API form but keep the stored token
    document.getElementById('apiForm').style.display = 'block';
    
    // Clear the input field but don't remove from localStorage
    document.getElementById('apiToken').value = '';
    
    // Reset WebSocket
    ws = null;
    
    addLogEntry('Disconnected. Enter new API token to reconnect.', 'warning');
});

// Add this function to reset trading stats
function resetTradingStats() {
    tradingStats.totalTrades = 0;
    tradingStats.wins = 0;
    tradingStats.losses = 0;
    tradingStats.profitLoss = 0;
    updateStats();
    addLogEntry('Trading statistics have been reset', 'warning');
}

// Add event listener for the refresh button
document.getElementById('refreshStats').addEventListener('click', function() {
    resetTradingStats();
});

// Add new function to subscribe to ticks
function subscribeToTicks() {
    const market = document.getElementById('market').value;
    ws.send(JSON.stringify({
        ticks: market,
        subscribe: 1
    }));
}

// Update handler for tick updates
function handleTick(tick) {
    if (!tick || !tick.quote) return;
    
    // Use the exact price from the API
    const price = tick.quote;
    
    // Convert to string and ensure proper decimal representation
    const priceString = price.toString().includes('.') ? price.toString() : price.toString() + '.0';
    
    // Get the last character after ensuring decimal representation
    const lastDigit = priceString.replace(/[^0-9]/g, '').slice(-1);
    
    // Update displays
    const priceDisplay = document.getElementById('currentPrice');
    const lastDigitDisplay = document.getElementById('lastDigit');
    
    if (priceDisplay) {
        // Display the exact price string with preserved decimals
        priceDisplay.textContent = priceString;
        // Update price color based on movement
        if (price > lastPrice) {
            priceDisplay.style.color = '#69f0ae';
        } else if (price < lastPrice) {
            priceDisplay.style.color = '#ff4081';
        }
    }
    
    if (lastDigitDisplay) {
        lastDigitDisplay.textContent = lastDigit;
        lastDigitDisplay.className = 'stat-value digit-display ' + 
            (parseInt(lastDigit) % 2 === 0 ? 'digit-even' : 'digit-odd');
    }
    
    // Store last price with proper decimal representation
    lastPrice = price;
}

// Update market selection reset to use proper decimal format
document.getElementById('market').addEventListener('change', function() {
    // Unsubscribe from previous market ticks
    ws.send(JSON.stringify({
        forget_all: 'ticks'
    }));
    
    // Subscribe to new market ticks
    subscribeToTicks();
    
    // Reset displays with proper decimal format
    document.getElementById('currentPrice').textContent = '0.0';
    document.getElementById('lastDigit').textContent = '0';
    lastPrice = 0;
});
</script>

<style>
    /* Add these styles */
    .card-title, 
    .text-muted, 
    .features, 
    label, 
    .form-text,
    .stat-value,
    .balance-value,
    .currency,
    .activity-log,
    #accountName,
    #accountType,
    #potentialPayout,
    #buyReturn {
        color: white !important;
    }
    
    .text-muted {
        color: rgba(255, 255, 255, 0.7) !important;
    }
    
    .form-control,
    .form-select {
        background-color: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
        color: white;
    }
    
    .form-control:focus,
    .form-select:focus {
        background-color: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        color: white;
    }
    
    .form-control::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }
    
    /* Keep success and error colors */
    .text-success {
        color: #69f0ae !important;
    }
    
    .text-danger {
        color: #ff5252 !important;
    }
    
    .text-warning {
        color: #ffd740 !important;
    }
    
    /* Style small helper text */
    .form-text {
        color: rgba(255, 255, 255, 0.6) !important;
    }
    
    /* Style select dropdowns */
    select option {
        background-color: #2c2c2c;
        color: white;
    }

    /* Keep existing styles and add activity log specific styles */
    .activity-log {
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        padding: 10px;
    }

    .log-entry {
        margin-bottom: 5px;
        padding: 5px;
        border-radius: 4px;
        background-color: rgba(255, 255, 255, 0.05);
    }

    /* Log entry types */
    .log-entry.info {
        color: #8be9fd !important;
    }

    .log-entry.success {
        color: #50fa7b !important;
    }

    .log-entry.warning {
        color: #ffb86c !important;
    }

    .log-entry.error {
        color: #ff5555 !important;
    }

    /* Scrollbar styling */
    .activity-log::-webkit-scrollbar {
        width: 8px;
    }

    .activity-log::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }

    .activity-log::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
    }

    .activity-log::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Add style for the refresh button */
    #refreshStats {
        border-color: rgba(255, 255, 255, 0.2);
        color: #ffd740;
    }

    #refreshStats:hover {
        background-color: rgba(255, 215, 64, 0.1);
    }

    .market-stat {
        text-align: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        margin-bottom: 10px;
    }

    .market-stat label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 5px;
    }

    .market-stat .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #69f0ae;
    }

    #currentPrice {
        font-family: 'Roboto Mono', monospace;
        font-size: 1.5rem;
        letter-spacing: 0.5px;
        font-weight: 500;
    }
    
    .price-up {
        color: #69f0ae;
        transition: color 0.2s ease;
    }
    
    .price-down {
        color: #ff4081;
        transition: color 0.2s ease;
    }
    
    .market-stat {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 1rem;
    }
    
    .market-stat label {
        font-size: 0.875rem;
        opacity: 0.7;
        margin-bottom: 0.5rem;
    }

    .digit-display {
        font-family: 'Roboto Mono', monospace;
        font-size: 2rem !important;
        font-weight: 700;
        padding: 0.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .digit-even {
        background-color: rgba(105, 240, 174, 0.1);
        color: #69f0ae !important;
    }

    .digit-odd {
        background-color: rgba(255, 64, 129, 0.1);
        color: #ff4081 !important;
    }

    .market-stat {
        text-align: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }

    .market-stat label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 10px;
        display: block;
    }

    #currentPrice {
        font-family: 'Roboto Mono', monospace;
        font-size: 1.5rem;
        letter-spacing: 0.5px;
    }
</style>
{% endblock %}