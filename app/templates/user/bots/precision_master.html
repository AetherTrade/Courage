{% extends "base.html" %}

{% block extra_css %}
<style>
    .api-card {
        background: rgba(26, 35, 126, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
    }
    .balance-card {
        background: linear-gradient(45deg, #1a237e, #303f9f);
        color: white;
    }
    .balance-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
    }
    .currency {
        font-size: 1rem;
        opacity: 0.8;
        color: white;
    }
    .status-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
    }
    .loading-spinner {
        display: none;
    }
    .is-loading .loading-spinner {
        display: inline-block;
    }
    .card-title, .form-label, .card-body, .text-muted {
        color: white !important;
    }
    .form-control {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }
    .form-control:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        color: white;
        box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.1);
    }
    .form-control::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }
    a {
        color: #69f0ae !important;
        text-decoration: none;
    }
    a:hover {
        color: #8ff7c3 !important;
        text-decoration: underline;
    }
    .btn-outline-secondary {
        color: white;
        border-color: rgba(255, 255, 255, 0.2);
    }
    .btn-outline-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
        color: white;
    }
    /* Activity Log styles */
    .activity-log {
        height: 300px;
        overflow-y: auto;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: 1rem;
    }
    
    .activity-log::-webkit-scrollbar {
        width: 8px;
    }
    
    .activity-log::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }
    
    .activity-log::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
    }
    
    .activity-log::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    .log-entry {
        padding: 0.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-family: 'Consolas', monospace;
        font-size: 0.9rem;
        color: white;
    }
    
    .log-entry:last-child {
        border-bottom: none;
    }
    
    .log-time {
        color: #69f0ae;
        margin-right: 0.5rem;
    }
    
    .log-type {
        display: inline-block;
        padding: 0.1rem 0.5rem;
        border-radius: 3px;
        margin-right: 0.5rem;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .log-type-info {
        background: rgba(33, 150, 243, 0.3);
        color: #90caf9;
    }
    
    .log-type-success {
        background: rgba(76, 175, 80, 0.3);
        color: #a5d6a7;
    }
    
    .log-type-warning {
        background: rgba(255, 152, 0, 0.3);
        color: #ffcc80;
    }
    
    .log-type-error {
        background: rgba(244, 67, 54, 0.3);
        color: #ef9a9a;
    }
    
    /* Add trading controls styles */
    .trading-controls {
        background: rgba(26, 35, 126, 0.3);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .trade-params {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .form-control:disabled {
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.5);
    }
    
    .profit {
        color: #69f0ae;
    }
    
    .loss {
        color: #ff4081;
    }
    
    .stats-card {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 0.5rem;
        padding: 1rem;
    }
    
    .stats-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    optgroup {
        background: rgba(26, 35, 126, 0.9);
        color: white;
    }
    
    option {
        background: rgba(38, 50, 170, 0.9);
        color: white;
        padding: 8px;
    }
    
    option:hover {
        background: rgba(63, 81, 181, 0.9);
    }
    
    .form-control option:checked {
        background: linear-gradient(45deg, #1a237e, #3f51b5);
    }

    /* Add styles for the disconnect button */
    #disconnectBtn {
        border: 1px solid rgba(255, 59, 48, 0.5);
        color: rgba(255, 59, 48, 0.9);
        transition: all 0.3s ease;
    }

    #disconnectBtn:hover {
        background: rgba(255, 59, 48, 0.1);
        border-color: rgba(255, 59, 48, 0.8);
        color: rgba(255, 59, 48, 1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card api-card mb-4">
                <div class="card-body">
                    <h3 class="card-title">CourageFX Trend Warrior</h3>
                    <p class="text-muted">Rise/Fall Market Expert</p>
                    
                    <div class="features mb-4">
                        <div><i class="bx bx-check text-success"></i> Trend direction analysis</div>
                        <div><i class="bx bx-check text-success"></i> Multiple timeframe strategy</div>
                        <div><i class="bx bx-check text-success"></i> Dynamic entry points</div>
                        <div><i class="bx bx-check text-success"></i> Automated trend following</div>
                    </div>
                    
                    <!-- API Connection Form -->
                    <form id="apiForm" class="mb-4">
                        <div class="mb-3">
                            <label for="apiToken" class="form-label">Deriv API Token</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="apiToken" 
                                       placeholder="Enter your Deriv API token">
                                <button class="btn btn-outline-secondary" type="button" id="toggleToken">
                                    <i class="bx bx-show"></i>
                                </button>
                            </div>
                            <small class="text-muted">
                                Don't have a token? 
                                <a href="https://app.deriv.com/account/api-token" target="_blank">
                                    Create one here
                                </a>
                            </small>
                        </div>
                        <button type="submit" class="btn btn-primary" id="connectBtn">
                            <span class="spinner-border spinner-border-sm loading-spinner" role="status"></span>
                            <i class="bx bx-link-alt me-2"></i>Connect
                        </button>
                    </form>

                    <!-- Account Info (Hidden until connected) -->
                    <div id="accountInfo" style="display: none;">
                        <div class="card balance-card text-white mb-4">
                            <div class="card-body">
                                <span class="status-badge badge bg-success">Connected</span>
                                <h5 class="card-title">Account Balance</h5>
                                <p class="balance-value mb-0">
                                    <span id="balanceAmount">0.00</span>
                                    <span class="currency" id="balanceCurrency">USD</span>
                                </p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Account Name</h6>
                                        <p class="mb-0" id="accountName">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Account Type</h6>
                                        <p class="mb-0" id="accountType">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Controls -->
            <div class="card api-card mb-4" id="tradingSection" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title mb-4">Trend Warrior Trading Bot</h5>
                    
                    <div class="trading-controls">
                        <div class="trade-params">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Stake Amount</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="stakeAmount" value="1" min="1" step="0.1">
                                        <span class="input-group-text" id="stakeCurrency">USD</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Duration</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="duration" value="5" min="1">
                                        <select class="form-select" id="durationType" style="max-width: 110px;">
                                            <option value="t">Ticks</option>
                                            <option value="m">Minutes</option>
                                        </select>
                                    </div>
                                    <div class="form-text text-white-50">
                                        <span id="durationHelp">Ticks: 1-10 | Minutes: 1-60</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Trading Strategy</label>
                                    <select class="form-control" id="tradingStrategy">
                                        <option value="trend">Trend Following</option>
                                        <option value="alternating">Counter Trend</option>
                                        <option value="martingale">Martingale</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Market</label>
                                    <select class="form-control" id="market">
                                        <optgroup label="1 Second Volatility">
                                            <option value="1HZ10V">Volatility 10 (1s)</option>
                                            <option value="1HZ25V">Volatility 25 (1s)</option>
                                            <option value="1HZ50V">Volatility 50 (1s)</option>
                                            <option value="1HZ75V">Volatility 75 (1s)</option>
                                            <option value="1HZ100V">Volatility 100 (1s)</option>
                                        </optgroup>
                                        <optgroup label="Standard Volatility">
                                            <option value="R_10">Volatility 10</option>
                                            <option value="R_25">Volatility 25</option>
                                            <option value="R_50">Volatility 50</option>
                                            <option value="R_75">Volatility 75</option>
                                            <option value="R_100">Volatility 100</option>
                                        </optgroup>
                                        <optgroup label="Crash/Boom">
                                            <option value="CRASH_1000">Crash 1000</option>
                                            <option value="BOOM_1000">Boom 1000</option>
                                            <option value="CRASH_500">Crash 500</option>
                                            <option value="BOOM_500">Boom 500</option>
                                        </optgroup>
                                    </select>
                                    <div class="form-text text-white-50">
                                        Select market type and volatility level
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <div class="btn-group">
                                <button class="btn btn-success btn-lg" id="startBot">
                                    <i class="bx bx-trending-up me-2"></i> Start Trend Warrior
                                </button>
                                <button class="btn btn-danger btn-lg" id="stopBot" disabled>
                                    <i class="bx bx-stop me-2"></i> Stop Trading
                                </button>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoAdjustStake">
                                <label class="form-check-label">Auto-adjust stake</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trading Stats -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <div class="stats-value" id="totalTrades">0</div>
                                <div class="stats-label">Total Trades</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <div class="stats-value profit" id="winCount">0</div>
                                <div class="stats-label">Wins</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <div class="stats-value loss" id="lossCount">0</div>
                                <div class="stats-label">Losses</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <div class="stats-value" id="profitLoss">0.00</div>
                                <div class="stats-label">Profit/Loss</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Log Card -->
            <div class="card api-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Activity Log</h5>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearLog()">
                            <i class="bx bx-trash"></i> Clear Log
                        </button>
                    </div>
                    <div id="activityLog" class="activity-log">
                        <!-- Log entries will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let ws = null;
let isTrading = false;
let currentContract = null;
let tradingStats = {
    totalTrades: 0,
    wins: 0,
    losses: 0,
    profitLoss: 0
};

// Add prediction type constants
const PREDICTIONS = {
    RISE: 'CALL',
    FALL: 'PUT'
};

document.addEventListener('DOMContentLoaded', function() {
    // Check for stored API token
    const storedToken = localStorage.getItem('deriv_api_token');
    if (storedToken) {
        document.getElementById('apiToken').value = storedToken;
        // Auto-connect if token exists
        document.getElementById('apiForm').dispatchEvent(new Event('submit'));
    }
    addLogEntry('Bot initialized and ready to connect', 'info');
});

document.getElementById('toggleToken').addEventListener('click', function() {
    const input = document.getElementById('apiToken');
    const icon = this.querySelector('i');
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bx-show');
        icon.classList.add('bx-hide');
    } else {
        input.type = 'password';
        icon.classList.remove('bx-hide');
        icon.classList.add('bx-show');
    }
});

// Add logging functionality
function addLogEntry(message, type = 'info') {
    const log = document.getElementById('activityLog');
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    
    const time = new Date().toLocaleTimeString();
    
    entry.innerHTML = `
        <span class="log-time">[${time}]</span>
        <span class="log-type log-type-${type}">${type.toUpperCase()}</span>
        <span class="log-message">${message}</span>
    `;
    
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
}

function clearLog() {
    const log = document.getElementById('activityLog');
    log.innerHTML = '';
    addLogEntry('Log cleared', 'info');
}

function updateStats() {
    document.getElementById('totalTrades').textContent = tradingStats.totalTrades;
    document.getElementById('winCount').textContent = tradingStats.wins;
    document.getElementById('lossCount').textContent = tradingStats.losses;
    document.getElementById('profitLoss').textContent = tradingStats.profitLoss.toFixed(2);
    
    // Update color of profit/loss
    const plElement = document.getElementById('profitLoss');
    plElement.className = 'stats-value ' + (tradingStats.profitLoss >= 0 ? 'profit' : 'loss');
}

function getNextPrediction(strategy, lastPrediction) {
    switch(strategy) {
        case 'alternating':
            return lastPrediction === PREDICTIONS.RISE ? PREDICTIONS.FALL : PREDICTIONS.RISE;
        case 'trend':
            return lastPrediction || PREDICTIONS.RISE; // Continue same direction or start with RISE
        case 'martingale':
            return lastPrediction || PREDICTIONS.RISE; // Keep same prediction after loss or start with RISE
        default:
            return PREDICTIONS.RISE;
    }
}

async function placeTrade() {
    if (!isTrading) return;
    
    const marketSelect = document.getElementById('market');
    const market = marketSelect.value;
    const marketName = marketSelect.options[marketSelect.selectedIndex].text;
    const stake = document.getElementById('stakeAmount').value;
    const duration = document.getElementById('duration').value;
    const durationType = document.getElementById('durationType').value;
    const strategy = document.getElementById('tradingStrategy').value;
    
    // Get next prediction based on strategy
    const prediction = getNextPrediction(strategy, currentContract?.lastPrediction);
    
    try {
        addLogEntry(`Preparing ${prediction} trade on ${marketName} for ${stake} USD`, 'info');
        
        const proposalRequest = {
            proposal: 1,
            amount: parseFloat(stake),
            basis: 'stake',
            contract_type: prediction, // Will be either 'CALL' or 'PUT'
            currency: 'USD',
            symbol: market,
            duration: parseInt(duration),
            duration_unit: durationType
        };
        
        ws.send(JSON.stringify(proposalRequest));
        addLogEntry(`Requesting ${prediction} trade proposal for ${duration} ${durationType === 't' ? 'ticks' : 'minutes'} on ${marketName}...`, 'info');
        
    } catch (error) {
        addLogEntry(`Trade error: ${error.message}`, 'error');
        stopTrading();
    }
}

function startTrading() {
    isTrading = true;
    document.getElementById('startBot').disabled = true;
    document.getElementById('stopBot').disabled = false;
    document.getElementById('stakeAmount').disabled = true;
    document.getElementById('duration').disabled = true;
    document.getElementById('market').disabled = true;
    document.getElementById('tradingStrategy').disabled = true;
    
    addLogEntry('Bot started trading', 'success');
    placeTrade();
}

function stopTrading() {
    isTrading = false;
    document.getElementById('startBot').disabled = false;
    document.getElementById('stopBot').disabled = true;
    document.getElementById('stakeAmount').disabled = false;
    document.getElementById('duration').disabled = false;
    document.getElementById('market').disabled = false;
    document.getElementById('tradingStrategy').disabled = false;
    
    addLogEntry('Bot stopped trading', 'warning');
}

document.getElementById('apiForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const connectBtn = document.getElementById('connectBtn');
    const token = document.getElementById('apiToken').value;

    try {
        connectBtn.classList.add('is-loading');
        connectBtn.disabled = true;

        // Store token in localStorage
        localStorage.setItem('deriv_api_token', token);
        
        addLogEntry('Initializing connection to Deriv...', 'info');
        
        // Initialize WebSocket connection
        ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');

        ws.onopen = function() {
            addLogEntry('WebSocket connection established', 'success');
            addLogEntry('Authorizing with API token...', 'info');
            ws.send(JSON.stringify({
                authorize: token
            }));
        };

        ws.onmessage = function(msg) {
            const data = JSON.parse(msg.data);
            
            if (data.msg_type === 'authorize') {
                if (data.error) {
                    addLogEntry(`Authorization failed: ${data.error.message}`, 'error');
                    // Remove invalid token
                    localStorage.removeItem('deriv_api_token');
                    throw new Error(data.error.message);
                }
                
                addLogEntry('Successfully authorized', 'success');
                addLogEntry(`Welcome back, ${data.authorize.fullname}`, 'info');
                
                document.getElementById('accountName').textContent = data.authorize.fullname;
                document.getElementById('accountType').textContent = 
                    data.authorize.landing_company_name.toUpperCase();

                document.getElementById('tradingSection').style.display = 'block';
                
                addLogEntry('Requesting account balance...', 'info');
                ws.send(JSON.stringify({
                    balance: 1,
                    subscribe: 1
                }));
            }
            
            if (data.msg_type === 'balance') {
                if (data.error) {
                    addLogEntry(`Balance request failed: ${data.error.message}`, 'error');
                    throw new Error(data.error.message);
                }
                
                const balance = parseFloat(data.balance.balance).toFixed(2);
                const currency = data.balance.currency;
                
                addLogEntry(`Account balance: ${balance} ${currency}`, 'success');
                
                document.getElementById('balanceAmount').textContent = balance;
                document.getElementById('balanceCurrency').textContent = currency;
                document.getElementById('stakeCurrency').textContent = currency;

                document.getElementById('accountInfo').style.display = 'block';
                document.getElementById('apiForm').style.display = 'none';
                
                connectBtn.classList.remove('is-loading');
                connectBtn.disabled = false;
            }
            
            // Handle proposal response
            if (data.msg_type === 'proposal') {
                if (data.error) {
                    addLogEntry(`Proposal error: ${data.error.message}`, 'error');
                    return;
                }
                
                // Place the trade with the proposal ID and price
                const buyRequest = {
                    buy: data.proposal.id,
                    price: data.proposal.ask_price
                };
                
                ws.send(JSON.stringify(buyRequest));
                addLogEntry('Proposal received, placing trade...', 'info');
            }
            
            // Handle buy response
            if (data.msg_type === 'buy') {
                if (data.error) {
                    addLogEntry(`Trade error: ${data.error.message}`, 'error');
                    return;
                }
                
                currentContract = {
                    id: data.buy.contract_id,
                    lastPrediction: data.buy.longcode.includes('Rise') ? PREDICTIONS.RISE : PREDICTIONS.FALL
                };
                
                addLogEntry(`Trade placed: ${data.buy.longcode}`, 'success');
                
                // Subscribe to contract updates
                ws.send(JSON.stringify({
                    proposal_open_contract: 1,
                    contract_id: currentContract.id,
                    subscribe: 1
                }));
            }
            
            // Handle contract updates
            if (data.msg_type === 'proposal_open_contract') {
                if (data.error) {
                    addLogEntry(`Contract error: ${data.error.message}`, 'error');
                    return;
                }
                
                const contract = data.proposal_open_contract;
                
                if (contract.is_sold) {
                    const profit = parseFloat(contract.profit);
                    tradingStats.totalTrades++;
                    
                    if (profit > 0) {
                        tradingStats.wins++;
                        addLogEntry(`Trade won: +${profit} USD`, 'success');
                        // On win, keep the same prediction for trend following
                        if (document.getElementById('tradingStrategy').value === 'trend') {
                            currentContract.lastPrediction = currentContract.lastPrediction;
                        }
                    } else {
                        tradingStats.losses++;
                        addLogEntry(`Trade lost: ${profit} USD`, 'error');
                        // On loss, consider switching prediction based on strategy
                        if (document.getElementById('tradingStrategy').value === 'alternating') {
                            currentContract.lastPrediction = 
                                currentContract.lastPrediction === PREDICTIONS.RISE ? 
                                PREDICTIONS.FALL : PREDICTIONS.RISE;
                        }
                    }
                    
                    tradingStats.profitLoss += profit;
                    updateStats();
                    
                    // Place next trade if still trading
                    if (isTrading) {
                        setTimeout(placeTrade, 1000);
                    }
                }
            }
        };

        ws.onerror = function(error) {
            addLogEntry('WebSocket error occurred', 'error');
            throw new Error('WebSocket error occurred');
        };

        ws.onclose = function() {
            addLogEntry('WebSocket connection closed', 'warning');
        };

    } catch (error) {
        addLogEntry(`Connection error: ${error.message}`, 'error');
        connectBtn.classList.remove('is-loading');
        connectBtn.disabled = false;
    }
});

// Add disconnect functionality
function disconnectBot() {
    if (ws) {
        ws.close();
    }
    // Remove token from localStorage
    localStorage.removeItem('deriv_api_token');
    document.getElementById('apiForm').style.display = 'block';
    document.getElementById('accountInfo').style.display = 'none';
    document.getElementById('tradingSection').style.display = 'none';
    addLogEntry('Disconnected from Deriv', 'warning');
}

// Add a disconnect button to the account info section
document.getElementById('accountInfo').innerHTML += `
    <button class="btn btn-outline-danger mt-3" id="disconnectBtn">
        <i class="bx bx-log-out"></i> Disconnect
    </button>
`;

document.getElementById('disconnectBtn').addEventListener('click', function() {
    if (confirm('Are you sure you want to disconnect? Your API token will be removed.')) {
        disconnectBot();
    }
});

// Update the window beforeunload handler
window.addEventListener('beforeunload', (event) => {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
    }
    // Don't remove the token on page reload/close
    // localStorage.removeItem('deriv_api_token');
});

// Add visibilitychange handler to reconnect when page becomes visible
document.addEventListener('visibilitychange', () => {
    const token = localStorage.getItem('deriv_api_token');
    if (!document.hidden && token && (!ws || ws.readyState !== WebSocket.OPEN)) {
        // Reconnect if we have a token and connection is closed
        document.getElementById('apiToken').value = token;
        document.getElementById('apiForm').dispatchEvent(new Event('submit'));
    }
});

// Event Listeners
document.getElementById('startBot').addEventListener('click', startTrading);
document.getElementById('stopBot').addEventListener('click', stopTrading);

// Add this to your existing JavaScript
document.getElementById('durationType').addEventListener('change', function() {
    const durationType = this.value;
    const durationInput = document.getElementById('duration');
    const durationHelp = document.getElementById('durationHelp');
    
    if (durationType === 't') {
        durationInput.max = 10;
        durationInput.min = 1;
        if (durationInput.value > 10) durationInput.value = 10;
        durationHelp.textContent = 'Ticks: 1-10';
    } else {
        durationInput.max = 60;
        durationInput.min = 1;
        durationHelp.textContent = 'Minutes: 1-60';
    }
});

// Add this to your existing JavaScript
document.getElementById('market').addEventListener('change', function() {
    const market = this.value;
    const durationType = document.getElementById('durationType');
    const duration = document.getElementById('duration');
    
    // Reset duration settings based on market type
    if (market.startsWith('1HZ')) {
        // 1-second markets typically use ticks
        durationType.value = 't';
        duration.max = 10;
        if (duration.value > 10) duration.value = 10;
        document.getElementById('durationHelp').textContent = 'Ticks: 1-10';
    } else {
        // Standard markets can use longer durations
        if (durationType.value === 't') {
            duration.max = 10;
            if (duration.value > 10) duration.value = 10;
        } else {
            duration.max = 60;
        }
    }
    
    addLogEntry(`Selected market: ${this.options[this.selectedIndex].text}`, 'info');
});
</script>
{% endblock %} 